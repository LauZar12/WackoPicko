name: Non-blocking security scans and Docker build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  scan-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep (non-blocking)
        run: |
          set +e
          docker run --rm -v "${{ github.workspace }}:/src" semgrep/semgrep \
            semgrep scan --config=p/default /src \
            --json --output=/src/semgrep-results.json
          echo "Semgrep completed (non-blocking)"
          set -e


      - name: Run Fluid Attacks SAST (non-blocking)
        run: |
          set +e
          docker run --rm -v "${{ github.workspace }}:/app" fluidattacks/sast:latest \
            sast --strict scan /app/sast-scan.yml
          echo "SAST completed (non-blocking)"
          set -e

      - name: Upload SAST CSV report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-report
          path: sast-report.csv
          if-no-files-found: ignore

      - name: Run Fluid Attacks SCA (non-blocking)
        run: |
          set +e
          docker run --rm -v "${{ github.workspace }}:/app" fluidattacks/sca:latest \
            sca --strict scan /app/sac-config.yml
          echo "SCA completed (non-blocking)"
          set -e

      - name: Build Docker image
        run: |
          echo "Building Docker image regardless of scan results..."
          docker build -t wackopicko-nonblocking .
